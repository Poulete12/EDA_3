<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Asso et Antony">
<meta name="dcterms.date" content="2025-06-02">

<title>Analyse multivariée des élections présidentielles : Méthodes PCA et CCA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="rapport_files/libs/clipboard/clipboard.min.js"></script>
<script src="rapport_files/libs/quarto-html/quarto.js"></script>
<script src="rapport_files/libs/quarto-html/popper.min.js"></script>
<script src="rapport_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="rapport_files/libs/quarto-html/anchor.min.js"></script>
<link href="rapport_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="rapport_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="rapport_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="rapport_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="rapport_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#données-et-méthodes" id="toc-données-et-méthodes" class="nav-link" data-scroll-target="#données-et-méthodes"><span class="header-section-number">0.1</span> Données et méthodes</a></li>
  <li><a href="#extraction-des-données-électorales" id="toc-extraction-des-données-électorales" class="nav-link" data-scroll-target="#extraction-des-données-électorales"><span class="header-section-number">1</span> Extraction des données électorales</a>
  <ul class="collapse">
  <li><a href="#sources-et-formats-de-données" id="toc-sources-et-formats-de-données" class="nav-link" data-scroll-target="#sources-et-formats-de-données"><span class="header-section-number">1.1</span> Sources et formats de données</a></li>
  <li><a href="#processus-dextraction" id="toc-processus-dextraction" class="nav-link" data-scroll-target="#processus-dextraction"><span class="header-section-number">1.2</span> Processus d’extraction</a></li>
  </ul></li>
  <li><a href="#nettoyage-des-données" id="toc-nettoyage-des-données" class="nav-link" data-scroll-target="#nettoyage-des-données"><span class="header-section-number">2</span> Nettoyage des données</a>
  <ul class="collapse">
  <li><a href="#harmonisation-des-variables-et-structure" id="toc-harmonisation-des-variables-et-structure" class="nav-link" data-scroll-target="#harmonisation-des-variables-et-structure"><span class="header-section-number">2.1</span> Harmonisation des variables et structure</a></li>
  <li><a href="#classification-en-familles-politiques" id="toc-classification-en-familles-politiques" class="nav-link" data-scroll-target="#classification-en-familles-politiques"><span class="header-section-number">2.2</span> Classification en familles politiques</a>
  <ul class="collapse">
  <li><a href="#nécessité-du-regroupement" id="toc-nécessité-du-regroupement" class="nav-link" data-scroll-target="#nécessité-du-regroupement"><span class="header-section-number">2.2.1</span> Nécessité du regroupement</a></li>
  <li><a href="#processus-de-mapping" id="toc-processus-de-mapping" class="nav-link" data-scroll-target="#processus-de-mapping"><span class="header-section-number">2.2.2</span> Processus de mapping</a></li>
  </ul></li>
  <li><a href="#sauvegarde-standardisée" id="toc-sauvegarde-standardisée" class="nav-link" data-scroll-target="#sauvegarde-standardisée"><span class="header-section-number">2.3</span> Sauvegarde standardisée</a></li>
  </ul></li>
  <li><a href="#analyses-statistiques-multivariées" id="toc-analyses-statistiques-multivariées" class="nav-link" data-scroll-target="#analyses-statistiques-multivariées"><span class="header-section-number">3</span> <strong>Analyses statistiques multivariées</strong></a>
  <ul class="collapse">
  <li><a href="#analyse-en-composantes-principales-pca" id="toc-analyse-en-composantes-principales-pca" class="nav-link" data-scroll-target="#analyse-en-composantes-principales-pca"><span class="header-section-number">3.1</span> Analyse en Composantes Principales (PCA)</a>
  <ul class="collapse">
  <li><a href="#objectif-et-méthodologie" id="toc-objectif-et-méthodologie" class="nav-link" data-scroll-target="#objectif-et-méthodologie"><span class="header-section-number">3.1.1</span> Objectif et méthodologie</a></li>
  <li><a href="#résultat-par-élection" id="toc-résultat-par-élection" class="nav-link" data-scroll-target="#résultat-par-élection"><span class="header-section-number">3.1.2</span> Résultat par élection</a></li>
  <li><a href="#interprétation-des-structures-politiques" id="toc-interprétation-des-structures-politiques" class="nav-link" data-scroll-target="#interprétation-des-structures-politiques"><span class="header-section-number">3.1.3</span> Interprétation des structures politiques</a></li>
  <li><a href="#rapprochement-centre-droite-en-2022" id="toc-rapprochement-centre-droite-en-2022" class="nav-link" data-scroll-target="#rapprochement-centre-droite-en-2022"><span class="header-section-number">3.1.4</span> Rapprochement Centre-Droite en 2022</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"><span class="header-section-number">3.1.5</span> </a></li>
  </ul></li>
  <li><a href="#analyse-des-corrélations-canoniques-cca" id="toc-analyse-des-corrélations-canoniques-cca" class="nav-link" data-scroll-target="#analyse-des-corrélations-canoniques-cca"><span class="header-section-number">3.2</span> Analyse des Corrélations Canoniques (CCA)</a>
  <ul class="collapse">
  <li><a href="#objectif-et-méthodologie-1" id="toc-objectif-et-méthodologie-1" class="nav-link" data-scroll-target="#objectif-et-méthodologie-1"><span class="header-section-number">3.2.1</span> Objectif et méthodologie</a></li>
  <li><a href="#résultats-des-comparaisons-temporelles" id="toc-résultats-des-comparaisons-temporelles" class="nav-link" data-scroll-target="#résultats-des-comparaisons-temporelles"><span class="header-section-number">3.2.2</span> Résultats des comparaisons temporelles</a></li>
  </ul></li>
  <li><a href="#synthèses" id="toc-synthèses" class="nav-link" data-scroll-target="#synthèses"><span class="header-section-number">3.3</span> <strong>Synthèses</strong></a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix"><span class="header-section-number">4</span> <strong>Appendix</strong></a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analyse multivariée des élections présidentielles : Méthodes PCA et CCA</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Asso et Antony </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 2, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="introduction">Introduction</h2>
<p>Ce rapport présente une analyse multivariée des élections présidentielles parisiennes de <strong>2007 à 2022</strong> en mobilisant deux méthodes statistiques principales : l’<strong>Analyse en Composantes Principales (PCA)</strong> et l’<strong>Analyse des Corrélations Canoniques (CCA)</strong>.</p>
</section>
<section id="données-et-méthodes" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="données-et-méthodes"><span class="header-section-number">0.1</span> Données et méthodes</h2>
<p>L’étude porte sur les résultats par bureau de vote parisien, regroupés en <strong>sept familles politiques</strong> : extrême gauche, gauche, écologistes, centre, droite, extrême droite et divers.</p>
<p>Notre pipeline comprend :</p>
<ol type="1">
<li><p><strong>Extraction et nettoyage</strong> des données électorales (formats parquet/Excel)</p></li>
<li><p><strong>Analyse PCA</strong> pour explorer la structure politique de chaque élection</p></li>
<li><p><strong>Analyse CCA</strong> pour mesurer la stabilité électorale entre scrutins consécutifs</p></li>
</ol>
<p>Les analyses CCA permettent d’identifier les bureaux de vote les plus stables/instables et de quantifier l’évolution du paysage électoral parisien sur quinze années.</p>
</section>
<section id="extraction-des-données-électorales" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Extraction des données électorales</h1>
<section id="sources-et-formats-de-données" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sources-et-formats-de-données"><span class="header-section-number">1.1</span> Sources et formats de données</h2>
<p>Les données électorales parisiennes proviennent de différentes sources institutionnelles (OpenData Paris, data.gouv.fr) et se présentent sous <strong>deux formats principaux</strong> :</p>
<ul>
<li><p><strong>Format Parquet</strong> : Elections européennes, présidentielles et régionales</p></li>
<li><p><strong>Format Excel</strong> : Elections municipales et législatives</p></li>
</ul>
<p>Cette hétérogénéité des formats nécessite le développement d’un pipeline d’extraction adaptatif capable de traiter chaque type de fichier avec les outils appropriés.</p>
</section>
<section id="processus-dextraction" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="processus-dextraction"><span class="header-section-number">1.2</span> Processus d’extraction</h2>
<p>Notre pipeline d’extraction s’adapte automatiquement aux deux formats de données rencontrés :</p>
<p><strong>Pour les fichiers Parquet</strong>, le package <strong><code>arrow</code></strong> est particulièrement adapté à ce format optimisé pour les données volumineuses. Les noms de fichiers sont standardisés pour harmoniser la nomenclature.</p>
<p><strong>Pour les fichiers Excel</strong>, le package <strong><code>readxl</code></strong> permet de traiter les données municipales et législatives. Le processus comprend à corriger des noms de colonnes, la conversion des colonnes au format approprié quand nécessaire et la fusion de multiples fichiers Excel.</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Elections extraites et analysées</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Titre</th>
<th style="text-align: right;">Tours</th>
<th style="text-align: right;">Année</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Européenne</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2009</td>
</tr>
<tr class="even">
<td style="text-align: left;">Européenne</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Européenne</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2019</td>
</tr>
<tr class="even">
<td style="text-align: left;">Européenne</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2024</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="even">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2007</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2012</td>
</tr>
<tr class="even">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2012</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2017</td>
</tr>
<tr class="even">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2017</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2022</td>
</tr>
<tr class="even">
<td style="text-align: left;">Présidentielle</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2022</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Régionale</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2010</td>
</tr>
<tr class="even">
<td style="text-align: left;">Régionale</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2010</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Régionale</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2015</td>
</tr>
<tr class="even">
<td style="text-align: left;">Régionale</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2015</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Régionale</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2021</td>
</tr>
<tr class="even">
<td style="text-align: left;">Régionale</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2021</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Municipale</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2008</td>
</tr>
<tr class="even">
<td style="text-align: left;">Municipale</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2008</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Municipale</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2014</td>
</tr>
<tr class="even">
<td style="text-align: left;">Municipale</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Municipale</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2020</td>
</tr>
<tr class="even">
<td style="text-align: left;">Municipale</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2020</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2012</td>
</tr>
<tr class="even">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2012</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2017</td>
</tr>
<tr class="even">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2017</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2022</td>
</tr>
<tr class="even">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2022</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2024</td>
</tr>
<tr class="even">
<td style="text-align: left;">Législative</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2024</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="nettoyage-des-données" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Nettoyage des données</h1>
<section id="harmonisation-des-variables-et-structure" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="harmonisation-des-variables-et-structure"><span class="header-section-number">2.1</span> Harmonisation des variables et structure</h2>
<p>Les données extraites présentent plusieurs défis structurels nécessitant une standardisation avant analyse.</p>
<p><strong>Suppression des colonnes non-pertinentes</strong> : Les données brutes contiennent de nombreuses variables administratives et métadonnées non-essentielles pour l’analyse électorale (dates de création, identifiants géographiques redondants, informations de géolocalisation). Ces colonnes sont systématiquement supprimées pour alléger les datasets.</p>
<p><strong>Harmonisation des noms</strong> : Les tables présentent des noms de colonnes différents pour des concepts identiques.</p>
<p><strong>Gestion des valeurs manquantes</strong> : Toutes les valeurs manquantes (<code>NA</code>) sont remplacées par des zéros, correspondant logiquement à l’absence de votes pour un candidat dans un bureau donné.</p>
</section>
<section id="classification-en-familles-politiques" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="classification-en-familles-politiques"><span class="header-section-number">2.2</span> Classification en familles politiques</h2>
<section id="nécessité-du-regroupement" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="nécessité-du-regroupement"><span class="header-section-number">2.2.1</span> Nécessité du regroupement</h3>
<p>Les données originales sont structurées par candidat individuel, rendant les comparaisons difficiles en raison des changements de personnalités politiques. Un regroupement en fonction de leur partie politique est donc nécessaire.</p>
</section>
<section id="processus-de-mapping" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="processus-de-mapping"><span class="header-section-number">2.2.2</span> Processus de mapping</h3>
<p>Le mapping candidat à famille politique s’avère particulièrement complexe à réaliser manuellement. Les ressources en ligne fiables étant rares et souvent incomplètes, nous avons eu recours à une intelligence artificielle pour générer des fichiers CSV de correspondance sous notre supervision.</p>
</section>
</section>
<section id="sauvegarde-standardisée" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="sauvegarde-standardisée"><span class="header-section-number">2.3</span> Sauvegarde standardisée</h2>
<p>Chaque élection nettoyée est sauvegardée au format Parquet dans le répertoire <code>DataClean/</code>, produisant des fichiers homogènes avec une structure identique facilitant les analyses ultérieures. Le processus transforme des données hétérogènes par candidat en datasets cohérents par famille politique.<br>
<br>
Pour illustrer le processus de nettoyage, voici un exemple concret avec les données des élections présidentielle 2022 du 1er tour :”</p>
<div class="cell" data-appendix="true">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 37
  id_bvote type_election  annee      numero_tour date_tour  circ_bv quartier_bv
  &lt;chr&gt;    &lt;chr&gt;          &lt;date&gt;           &lt;int&gt; &lt;date&gt;     &lt;chr&gt;   &lt;chr&gt;      
1 18-45    Présidentielle 2022-01-01           1 2022-04-10 03      69         
2 18-66    Présidentielle 2022-01-01           1 2022-04-10 18      70         
3 16-62    Présidentielle 2022-01-01           1 2022-04-10 04      64         
4 16-66    Présidentielle 2022-01-01           1 2022-04-10 04      64         
5 18-40    Présidentielle 2022-01-01           1 2022-04-10 03      69         
6 20-69    Présidentielle 2022-01-01           1 2022-04-10 06      79         
# ℹ 30 more variables: arr_bv &lt;chr&gt;, sec_bv &lt;chr&gt;, num_bureau &lt;int&gt;,
#   nb_procuration &lt;dbl&gt;, nb_inscrit &lt;dbl&gt;, nb_emargement &lt;dbl&gt;,
#   nb_votant &lt;int&gt;, nb_vote_blanc &lt;dbl&gt;, nb_vote_nul &lt;dbl&gt;, nb_exprime &lt;dbl&gt;,
#   arthaud_nathalie &lt;int&gt;, roussel_fabien &lt;dbl&gt;, macron_emmanuel &lt;dbl&gt;,
#   lassalle_jean &lt;dbl&gt;, le_pen_marine &lt;dbl&gt;, zemmour_eric &lt;dbl&gt;,
#   melenchon_jean_luc &lt;dbl&gt;, hidalgo_anne &lt;dbl&gt;, jadot_yannick &lt;dbl&gt;,
#   pecresse_valerie &lt;int&gt;, poutou_philippe &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Voici le dataset après application du processus de nettoyage :</p>
<div class="cell" data-appendix="true">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 18
  id_bvote nb_procuration nb_inscrit nb_emargement nb_votant nb_bl_nul
  &lt;chr&gt;             &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
1 18-45                42       1611          1129      1129        15
2 18-66                64       1426          1132      1132        10
3 16-62                77       1523          1230      1233        12
4 16-66                57       1246           944       944         8
5 18-40                78       1591          1285      1286        23
6 20-69                86       1550          1205      1205        18
# ℹ 12 more variables: nb_exprime &lt;dbl&gt;, EXG &lt;dbl&gt;, COM &lt;dbl&gt;, ENS &lt;dbl&gt;,
#   REG &lt;dbl&gt;, RN &lt;dbl&gt;, REC &lt;dbl&gt;, LFI &lt;dbl&gt;, SOC &lt;dbl&gt;, ECO &lt;dbl&gt;, LR &lt;int&gt;,
#   DSV &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="analyses-statistiques-multivariées" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> <strong>Analyses statistiques multivariées</strong></h1>
<section id="analyse-en-composantes-principales-pca" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="analyse-en-composantes-principales-pca"><span class="header-section-number">3.1</span> Analyse en Composantes Principales (PCA)</h2>
<section id="objectif-et-méthodologie" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="objectif-et-méthodologie"><span class="header-section-number">3.1.1</span> Objectif et méthodologie</h3>
<p>L’Analyse en Composantes Principales permet de réduire la dimensionnalité des données électorales tout en conservant l’information essentielle. Appliquée aux scores des sept familles politiques par bureau de vote, elle révèle les structures sous-jacentes du vote parisien.</p>
<p>La méthodologie consiste à :</p>
<ul>
<li><p>Calculer les scores par famille politique pour chaque bureau de vote</p></li>
<li><p>Appliquer une PCA avec standardisation des variables</p></li>
<li><p>Analyser la variance expliquée par les composantes principales</p></li>
<li><p>Visualiser appropriées</p></li>
</ul>
<p>Dans notre cas, nous appliquons la PCA aux <strong>élections présidentielles de 2022, 2017, 2012</strong> pour analyser l’évolution des structures politiques sur quinze années.</p>
</section>
<section id="résultat-par-élection" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="résultat-par-élection"><span class="header-section-number">3.1.2</span> Résultat par élection</h3>
<section id="élection-présidentielle-2022" class="level4" data-number="3.1.2.1">
<h4 data-number="3.1.2.1" class="anchored" data-anchor-id="élection-présidentielle-2022"><span class="header-section-number">3.1.2.1</span> Élection présidentielle 2022</h4>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2022_eig-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>La PCA révèle que les deux premières composantes expliquent <strong>70,8% de la variance totale</strong> (PC1 = 53%, PC2 = 18%).</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2022_var-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Composante 1 (53%)</strong> : Oppose clairement <strong>gauche/extrême-gauche/écologistes</strong> (scores négatifs) au <strong>centre/droite/extrême-droite</strong> (scores positifs). Cet axe reproduit le clivage idéologique classique gauche-droite.</p>
<p><strong>Composante 2 (18%)</strong> : Distingue l’<strong>extrême-droite</strong> (scores positifs) au reste (scores négatifs) )</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2022_ind-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>La projection des bureaux de vote montre une <strong>séparation nette</strong> : les bureaux dominés par le centre (points bleus) se concentrent à droite, tandis que ceux dominés par la gauche (points rouges) se situent à gauche, avec très peu de chevauchement entre les ellipses.</p>
</section>
<section id="élection-présidentielle-2017" class="level4" data-number="3.1.2.2">
<h4 data-number="3.1.2.2" class="anchored" data-anchor-id="élection-présidentielle-2017"><span class="header-section-number">3.1.2.2</span> Élection présidentielle 2017</h4>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2017_eig-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>La PCA explique <strong>74,8% de la variance totale</strong> avec les deux premières composantes (PC1 = 53,5%, PC2 = 21,3%).</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2017_var-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Composante 1 (53,5%)</strong> : Oppose la <strong>droite traditionnelle (LR/Fillon)</strong> (scores négatifs) au <strong>bloc mixte gauche + extrême-droite + divers</strong> (scores positifs). Cet axe ne suit pas le clivage gauche-droite classique mais distingue la droite modérée du reste du spectre politique.</p>
<p><strong>Composante 2 (21,3%)</strong> : Affine le vote “radical” en distinguant l’<strong>extrême-droite FN</strong> (scores positifs élevés) de la <strong>gauche modérée/centre</strong> (scores négatifs).</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2017_ind-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Le nuage révèle <strong>trois clusters bien distincts</strong> avec des ellipses très séparées : droite classique LR/Fillon (PC1 &lt; 0), gauche modérée PS/LFI/Hamon (PC1 &lt; 0, PC2 &gt; 0), et extrême-droite FN (PC1 &gt; 0). Cette configuration illustre un paysage politique structuré en <strong>trois îlots nets</strong> plutôt qu’un clivage gauche-droite traditionnel comme évoqué précedement.</p>
</section>
<section id="élection-présidentielle-2012" class="level4" data-number="3.1.2.3">
<h4 data-number="3.1.2.3" class="anchored" data-anchor-id="élection-présidentielle-2012"><span class="header-section-number">3.1.2.3</span> Élection présidentielle 2012</h4>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2012_eig-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Élection présidentielle 2012</strong> La PCA explique <strong>74,9% de la variance totale</strong> avec les deux premières composantes (PC1 = 51,3%, PC2 = 23,6%).</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2012_var-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Composante 1 (51,3%)</strong> : Oppose la <strong>droite modérée (UMP/Sarkozy)</strong> (scores négatifs) au <strong>bloc gauche + écologistes + extrêmes + divers</strong> (scores positifs). Cet axe ne reproduit pas le clivage gauche-droite classique mais isole la droite modérée de l’ensemble du reste de l’échiquier politique.</p>
<p><strong>Composante 2 (23,6%)</strong> : Affine chaque bloc en distinguant les bureaux <strong>écologie/gauche modérée</strong> (scores positifs) des bureaux au reste des parties (scores négatifs).</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/pca_2012_ind-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Le nuage montre une <strong>séparation horizontale</strong> : tous les bureaux “gauche dominante” (points rouges) se situent à droite (PC1 &gt; 0), tandis que tous les bureaux “extrême-droite dominante” (points bleus) se placent à gauche (PC1 &lt; 0)</p>
</section>
</section>
<section id="interprétation-des-structures-politiques" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="interprétation-des-structures-politiques"><span class="header-section-number">3.1.3</span> Interprétation des structures politiques</h3>
<p>Les analyses PCA révèlent une <strong>évolution majeure du paysage politique parisien</strong> :</p>
<p><strong>2012</strong> : Structure classique avec isolation de la droite modérée (UMP) face au reste de l’échiquier politique.</p>
<p><strong>2017</strong> : <strong>Recomposition en trois îlots distincts</strong> - droite traditionnelle (LR), gauche modérée (PS/LFI), et extrême-droite (FN) - illustrant l’éclatement du système politique traditionnel.</p>
<p><strong>2022</strong> : <strong>Retour à une bipolarisation</strong> centre (Macron) versus gauche élargie, avec l’extrême-droite intégrée comme nuance verticale plutôt que comme bloc autonome.</p>
<p>Cette évolution montre le <strong>passage d’un clivage gauche-droite classique</strong> (2012) vers une <strong>triangulation politique</strong> (2017) puis vers une <strong>nouvelle bipolarisation centre-gauche</strong> (2022)</p>
</section>
<section id="rapprochement-centre-droite-en-2022" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="rapprochement-centre-droite-en-2022"><span class="header-section-number">3.1.4</span> Rapprochement Centre-Droite en 2022</h3>
</section>
<section id="section" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="section"><span class="header-section-number">3.1.5</span> </h3>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/correlations-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>L’analyse suggère un retour vers un clivage similaire à 2012. Le graphique des variables PCA montre la proximité du centre et de la droite sur PC1, qui structure l’opposition gauche-droite. La matrice de corrélations confirme cette observation avec un coefficient de 0,75 entre ces deux familles politiques.</p>
<p>Cette forte corrélation indique une convergence électorale centre-droite rappelant les dynamiques de 2012, interrogeant ainsi l’évolution du paysage politique parisien.</p>
</section>
</section>
<section id="analyse-des-corrélations-canoniques-cca" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="analyse-des-corrélations-canoniques-cca"><span class="header-section-number">3.2</span> Analyse des Corrélations Canoniques (CCA)</h2>
<section id="objectif-et-méthodologie-1" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="objectif-et-méthodologie-1"><span class="header-section-number">3.2.1</span> Objectif et méthodologie</h3>
<p>L’Analyse des Corrélations Canoniques mesure la stabilité électorale en comparant les bureaux de vote entre deux élections consécutives. Elle identifie les bureaux de vote ayant maintenu des comportements électoraux cohérents versus ceux ayant connu des basculements significatifs.</p>
<p>La méthodologie comprend :</p>
<ul>
<li><p><strong>Normalisation</strong> : Conversion des scores en pourcentages par bureau de vote</p></li>
<li><p><strong>Jointure</strong> : Jointure naturel des données par identifiant de bureau (id_bvote)</p></li>
<li><p><strong>CCA</strong> : Calcul des corrélations canoniques et scores canoniques</p></li>
<li><p><strong>Identification</strong> : Bureaux instables</p></li>
</ul>
</section>
<section id="résultats-des-comparaisons-temporelles" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="résultats-des-comparaisons-temporelles"><span class="header-section-number">3.2.2</span> Résultats des comparaisons temporelles</h3>
<section id="stabilité-2022-2017" class="level4" data-number="3.2.2.1">
<h4 data-number="3.2.2.1" class="anchored" data-anchor-id="stabilité-2022-2017"><span class="header-section-number">3.2.2.1</span> Stabilité 2022-2017</h4>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/CCA_2022-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>La corrélation canonique de <strong>0,992</strong> révèle une <strong>fidélité électorale exceptionnelle</strong> : la quasi-totalité des bureaux maintient un positionnement cohérent sur l’axe gauche-droite entre les deux scrutins.</p>
<p>Le nuage de points s’aligne parfaitement sur la diagonale, confirmant que les bureaux conservent leur position relative. Dans cette analyse, les <strong>scores faibles correspondent aux profils de gauche</strong> (coefficients CCA négatifs pour PS/LFI) et les <strong>scores élevés aux profils centre-droite</strong> (coefficients CCA positifs pour LR/RN/En Marche) - cette convention étant déterminée par l’algorithme CCA.</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Top 10 des bureaux ayant le plus changé</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Bureau de vote</th>
<th style="text-align: right;">Distance diagonale</th>
<th style="text-align: right;">Score</th>
<th style="text-align: right;">Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">13-33</td>
<td style="text-align: right;">26.01165</td>
<td style="text-align: right;">16.87902</td>
<td style="text-align: right;">-9.132635</td>
</tr>
<tr class="even">
<td style="text-align: left;">20-29</td>
<td style="text-align: right;">25.65573</td>
<td style="text-align: right;">17.07589</td>
<td style="text-align: right;">-8.579833</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17-1</td>
<td style="text-align: right;">25.65475</td>
<td style="text-align: right;">18.33011</td>
<td style="text-align: right;">-7.324638</td>
</tr>
<tr class="even">
<td style="text-align: left;">18-27</td>
<td style="text-align: right;">25.64897</td>
<td style="text-align: right;">17.26387</td>
<td style="text-align: right;">-8.385092</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13-42</td>
<td style="text-align: right;">25.62823</td>
<td style="text-align: right;">16.85094</td>
<td style="text-align: right;">-8.777288</td>
</tr>
<tr class="even">
<td style="text-align: left;">10-16</td>
<td style="text-align: right;">25.61985</td>
<td style="text-align: right;">16.71621</td>
<td style="text-align: right;">-8.903642</td>
</tr>
<tr class="odd">
<td style="text-align: left;">14-52</td>
<td style="text-align: right;">25.61947</td>
<td style="text-align: right;">17.35895</td>
<td style="text-align: right;">-8.260528</td>
</tr>
<tr class="even">
<td style="text-align: left;">15-64</td>
<td style="text-align: right;">25.61376</td>
<td style="text-align: right;">18.59188</td>
<td style="text-align: right;">-7.021883</td>
</tr>
<tr class="odd">
<td style="text-align: left;">13-3</td>
<td style="text-align: right;">25.61335</td>
<td style="text-align: right;">17.28323</td>
<td style="text-align: right;">-8.330121</td>
</tr>
<tr class="even">
<td style="text-align: left;">18-5</td>
<td style="text-align: right;">25.60701</td>
<td style="text-align: right;">17.46858</td>
<td style="text-align: right;">-8.138429</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>On constate que les bureaux instable se caractérisés par un <strong>basculement gauche centre-droite</strong> : scores 2017 très négatifs versus scores 2022 très positifs.</p>
<p>Le <strong>13e arrondissement</strong> concentre les plus fortes instabilités avec <strong>3 bureaux dans le top 10</strong>, dont le <strong>bureau le plus instable</strong> (13-33). Cela représente des “poches de bascule”.</p>
</section>
<section id="stabilité-2017-2012" class="level4" data-number="3.2.2.2">
<h4 data-number="3.2.2.2" class="anchored" data-anchor-id="stabilité-2017-2012"><span class="header-section-number">3.2.2.2</span> Stabilité 2017-2012</h4>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="rapport_files/figure-html/CCA_2017-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>La corrélation canonique de <strong>0,949</strong> indique une <strong>forte stabilité électorale</strong> entre ces deux scrutins.</p>
<p><br>
Le nuage de points se concentre majoritairement sur la diagonale, confirmant que les bureaux conservent leur positionnement relatif sur l’axe gauche-droite. Cependant, la stabilité est légèrement moindre qu’en 2017-2022.</p>
<div class="cell" data-appendix="true">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Top 10 des bureaux ayant le plus changé</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Bureau de vote</th>
<th style="text-align: right;">Distance diagonale</th>
<th style="text-align: right;">Score</th>
<th style="text-align: right;">Score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">17-61</td>
<td style="text-align: right;">4.602078</td>
<td style="text-align: right;">6.248552</td>
<td style="text-align: right;">1.646474</td>
</tr>
<tr class="even">
<td style="text-align: left;">17-15</td>
<td style="text-align: right;">3.694057</td>
<td style="text-align: right;">5.591578</td>
<td style="text-align: right;">1.897521</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17-63</td>
<td style="text-align: right;">3.440543</td>
<td style="text-align: right;">5.940505</td>
<td style="text-align: right;">2.499962</td>
</tr>
<tr class="even">
<td style="text-align: left;">17-14</td>
<td style="text-align: right;">3.303613</td>
<td style="text-align: right;">5.411394</td>
<td style="text-align: right;">2.107781</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17-12</td>
<td style="text-align: right;">3.275898</td>
<td style="text-align: right;">5.119594</td>
<td style="text-align: right;">1.843696</td>
</tr>
<tr class="even">
<td style="text-align: left;">17-13</td>
<td style="text-align: right;">3.248688</td>
<td style="text-align: right;">4.738446</td>
<td style="text-align: right;">1.489758</td>
</tr>
<tr class="odd">
<td style="text-align: left;">17-6</td>
<td style="text-align: right;">3.206055</td>
<td style="text-align: right;">5.054208</td>
<td style="text-align: right;">1.848153</td>
</tr>
<tr class="even">
<td style="text-align: left;">17-62</td>
<td style="text-align: right;">3.113680</td>
<td style="text-align: right;">6.124483</td>
<td style="text-align: right;">3.010803</td>
</tr>
<tr class="odd">
<td style="text-align: left;">9-24</td>
<td style="text-align: right;">2.979646</td>
<td style="text-align: right;">4.263810</td>
<td style="text-align: right;">1.284164</td>
</tr>
<tr class="even">
<td style="text-align: left;">16-35</td>
<td style="text-align: right;">2.977137</td>
<td style="text-align: right;">6.763201</td>
<td style="text-align: right;">3.786064</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Les <strong>10 bureaux les plus instables</strong> présentent tous un <strong>basculement gauche → centre-droite</strong> : scores 2012 faibles (profil très à gauche/extrême) versus scores 2017 élevés (profil centre-droite). Le <strong>17e arrondissement</strong> domine avec plusieurs bureaux instables, illustrant des mutations locales où d’anciens bastions de gauche se sont convertis en zones centre-droite.</p>
</section>
</section>
</section>
<section id="synthèses" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="synthèses"><span class="header-section-number">3.3</span> <strong>Synthèses</strong></h2>
<p><strong>1. Validation méthodologique</strong> Cette analyse démontre l’efficacité des <strong>méthodes de factorisation matricielle (SVD/PCA/CCA)</strong> pour l’analyse électorale :</p>
<ul>
<li><p><strong>PCA</strong> : révèle les structures politiques et leur évolution temporelle</p></li>
<li><p><strong>CCA</strong> : quantifie précisément la stabilité électorale entre scrutins</p></li>
<li><p><strong>Pipeline de nettoyage</strong> : harmonise les données multi-temporelles</p></li>
</ul>
<p><strong>2. Découvertes sur le paysage politique parisien (2012-2022)</strong></p>
<p><strong>Évolution structurelle en trois phases :</strong></p>
<ul>
<li><p><strong>2012</strong> : Bipolarisation traditionnelle (droite modérée vs bloc gauche/écolo)</p></li>
<li><p><strong>2017</strong> : <strong>Tripartition politique</strong> (LR, PS/LFI, FN) - éclatement du système</p></li>
<li><p><strong>2022</strong> : <strong>Nouvelle bipolarisation</strong> (centre macroniste vs gauche élargie)</p></li>
</ul>
<p><strong>Stabilité paradoxale :</strong></p>
<ul>
<li><p><strong>Fidélité globale exceptionnelle</strong> (corrélations 0,949 et 0,992)</p></li>
<li><p>Mais <strong>recompositions géographiquement concentrées</strong> (13e, 17e arrondissements)</p></li>
<li><p><strong>Direction unique des basculements</strong> : gauche → centre-droite</p></li>
</ul>
</section>
</section>
<section id="appendix" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> <strong>Appendix</strong></h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CCA)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Pour le moment je cherche uniquement les elections Europenne, Présidentielle et Régionalme car se sont les seuls qui sont sous le format parquet </span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>parquet_dir <span class="ot">&lt;-</span> <span class="st">"Data/Election/parquet"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>parquet_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(parquet_dir, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Variable qui va permettre de socker toutes nos dataset</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>all_elections <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> parquet_files) {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  file_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(file))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  clean_name <span class="ot">&lt;-</span> file_name <span class="sc">%&gt;%</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_remove</span>(<span class="st">"elections-"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(<span class="st">"1ertour"</span>,<span class="st">"1t"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(<span class="st">"2emetour"</span>,<span class="st">"2t"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace_all</span>(<span class="st">"-"</span>,<span class="st">"_"</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(file) </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  all_elections[[clean_name]] <span class="ot">&lt;-</span> data</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Fonction pour nettoyer les noms et prénoms</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>cleaning_name <span class="ot">&lt;-</span> <span class="cf">function</span>(text, <span class="at">type =</span> <span class="st">"person"</span>) {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(text) <span class="sc">||</span> <span class="fu">is.null</span>(text) <span class="sc">||</span> text <span class="sc">==</span> <span class="st">""</span>) <span class="fu">return</span>(<span class="st">""</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_to_lower</span>(text)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[àáâãäå]"</span>, <span class="st">"a"</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"ç"</span>, <span class="st">"c"</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[èéêë]"</span>, <span class="st">"e"</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[ìíîï]"</span>, <span class="st">"i"</span>)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"ñ"</span>, <span class="st">"n"</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[òóôõöø]"</span>, <span class="st">"o"</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[ùúûü]"</span>, <span class="st">"u"</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[ýÿ]"</span>, <span class="st">"y"</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[^a-z]"</span>, <span class="st">"_"</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"column"</span>) {</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[ -]"</span>, <span class="st">"_"</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"[ </span><span class="sc">\\</span><span class="st">-'</span><span class="sc">\"</span><span class="st">()</span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">]]"</span>, <span class="st">"_"</span>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(text_clean, <span class="st">"_{2,}"</span>, <span class="st">"_"</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  text_clean <span class="ot">&lt;-</span> <span class="fu">str_remove_all</span>(text_clean, <span class="st">"^_|_$"</span>)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(text_clean)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co">#Fonction permettant de convertir en int </span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>convert_to_numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(x))</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    result[<span class="fu">is.na</span>(result)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(result)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co">#Fonction permettant l'extractions des fichiers excel</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>extract_xls <span class="ot">&lt;-</span> <span class="cf">function</span>(base_dir){  </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  new_data <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  dir_muni <span class="ot">&lt;-</span> <span class="fu">list.dirs</span>(base_dir, <span class="at">full.names =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(dir <span class="cf">in</span> dir_muni){</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    dir_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_dir,dir)</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    excel_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    regroup <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(file <span class="cf">in</span> excel_files){</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(file,<span class="at">col_types =</span> <span class="st">"text"</span>)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>      file_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(file)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>      regroup[[file_name]] <span class="ot">&lt;-</span> data</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Leger préparation des collones </span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    all_excel <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(regroup)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(all_excel) <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">names</span>(all_excel), <span class="cf">function</span>(x) <span class="fu">cleaning_name</span>(x, <span class="at">type =</span> <span class="st">"column"</span>), <span class="at">USE.NAMES =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Supprésion des colonnes vides</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    empty_cols <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(all_excel) <span class="sc">==</span> <span class="st">""</span> <span class="sc">|</span> <span class="fu">is.na</span>(<span class="fu">names</span>(all_excel)))</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(empty_cols) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>      all_excel <span class="ot">&lt;-</span> all_excel[, <span class="sc">-</span>empty_cols]</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Convertion des colonnes </span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    columns_to_ignore <span class="ot">&lt;-</span>  <span class="fu">c</span>(<span class="st">"id_bvote"</span>, <span class="st">"scrutin"</span>, <span class="st">"annee"</span>, <span class="st">"date"</span>)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    columns_to_convert <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(all_excel), columns_to_ignore)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    all_excel <span class="ot">&lt;-</span> all_excel <span class="sc">%&gt;%</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(columns_to_convert), convert_to_numeric))</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    new_data[[dir]] <span class="ot">&lt;-</span> all_excel</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(new_data)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a><span class="co">#Rajout dans notre liste all_elections</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>muni_data <span class="ot">&lt;-</span> <span class="fu">extract_xls</span>(<span class="st">"Data/Election/Municipale"</span>)</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>legi_data <span class="ot">&lt;-</span> <span class="fu">extract_xls</span>(<span class="st">"Data/Election/Legislative"</span>)</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>all_elections <span class="ot">&lt;-</span> <span class="fu">c</span>(all_elections, muni_data, legi_data)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Extraction des informations depuis all_elections</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>elections_info <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">titre =</span> <span class="fu">character</span>(),</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">tours =</span> <span class="fu">numeric</span>(),</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">annee =</span> <span class="fu">numeric</span>()</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(name <span class="cf">in</span> <span class="fu">names</span>(all_elections)) {</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"presidentiel"</span>, name, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> <span class="st">"Présidentielle"</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"europeennes"</span>, name, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> <span class="st">"Européenne"</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"muni"</span>, name, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> <span class="st">"Municipale"</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"legi"</span>, name, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> <span class="st">"Législative"</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"regional"</span>, name, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> <span class="st">"Régionale"</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    type <span class="ot">&lt;-</span> <span class="st">"Autre"</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>  annee <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">str_extract</span>(name, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"_1t|_2t"</span>, name)) {</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>    tours <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"_2t"</span>, name), <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    tours <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>  elections_info <span class="ot">&lt;-</span> <span class="fu">rbind</span>(elections_info, </span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">data.frame</span>(type, tours,annee))</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(elections_info, </span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Titre"</span>, <span class="st">"Tours"</span>, <span class="st">"Année"</span>),</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Elections extraites et analysées"</span>)</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>admin_cols_possible <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>  <span class="st">"id_bv"</span>, <span class="st">"num_bureau"</span>, <span class="st">"id_arrondissement"</span>, <span class="st">"arr"</span>, <span class="st">"secteur"</span>, <span class="st">"quartier"</span>,</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nb_inscr"</span>, <span class="st">"nb_votant"</span>, <span class="st">"nb_exprim"</span>, <span class="st">"nb_bl_nul"</span>, <span class="st">"nb_blanc"</span>, <span class="st">"nb_nul"</span>,</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nb_vote_blanc"</span>, <span class="st">"nb_vote_nul"</span>, <span class="st">"nb_emarg"</span>,<span class="st">"nb_procu"</span>, </span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>  <span class="st">"circ_legislative"</span>,<span class="st">"type_election"</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>find_csv_file <span class="ot">&lt;-</span> <span class="cf">function</span>(election_name, nuances_dir) {</span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># D'abord essayer le nom exact</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>  exact_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(nuances_dir, <span class="fu">paste0</span>(election_name, <span class="st">".csv"</span>))</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(exact_path)) {</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(exact_path)</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>  base_name <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_[12]?t$|_t[12]$"</span>, <span class="st">""</span>, election_name)</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>  base_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(nuances_dir, <span class="fu">paste0</span>(base_name, <span class="st">".csv"</span>))</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(base_path)) {</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(base_path)</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a><span class="co">#Mapping des tables</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>mapping <span class="ot">&lt;-</span> <span class="cf">function</span>(election_data, nuance_file_path, election_name) {</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>  candidats_nuances <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(nuance_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>  cols_candidats <span class="ot">&lt;-</span> <span class="fu">names</span>(election_data)[<span class="sc">!</span><span class="fu">names</span>(election_data) <span class="sc">%in%</span> admin_cols_possible]</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>  election_new <span class="ot">&lt;-</span> election_data</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col_candidat <span class="cf">in</span> cols_candidats) {</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trouver la nuance correspondante</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>    nuance_candidat <span class="ot">&lt;-</span> candidats_nuances<span class="sc">$</span>code_nuance[candidats_nuances<span class="sc">$</span>nom_prenom <span class="sc">==</span> col_candidat]</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(nuance_candidat) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>      nuance <span class="ot">&lt;-</span> nuance_candidat[<span class="dv">1</span>]</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Vérifier si une colonne avec cette nuance existe déjà</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (nuance <span class="sc">%in%</span> <span class="fu">names</span>(election_new)) {</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Additionner les valeurs</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>        election_new[[nuance]] <span class="ot">&lt;-</span> election_new[[nuance]] <span class="sc">+</span> election_new[[col_candidat]]</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Supprimer l'ancienne colonne candidat</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>        election_new[[col_candidat]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Renommer la colonne</span></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(election_new)[<span class="fu">names</span>(election_new) <span class="sc">==</span> col_candidat] <span class="ot">&lt;-</span> nuance</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(election_new)</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_elections[[<span class="st">"presidentielles_2022_1t"</span>]])</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Nettoyage de chaque élection</span></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(name <span class="cf">in</span> <span class="fu">names</span>(all_elections)){</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> all_elections[[name]]</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>  <span class="co">#On fussionne les votes nuls et blancs dans les data où elles sont séparées</span></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>  blanc <span class="ot">&lt;-</span> <span class="fu">any</span>(<span class="fu">str_detect</span>(<span class="fu">names</span>(data),<span class="st">"nb_bl$|nb_blanc$|nb_vote_blanc$"</span>))</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>  exprim <span class="ot">&lt;-</span><span class="fu">any</span>(<span class="fu">str_detect</span>(<span class="fu">names</span>(data),<span class="st">"nb_exprim$"</span>))</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(blanc){</span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>    blanc_col <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="fu">str_detect</span>(<span class="fu">names</span>(data), <span class="st">"nb_bl$|nb_blanc$|nb_vote_blanc$"</span>)][<span class="dv">1</span>]</span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>    nul_col <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="fu">str_detect</span>(<span class="fu">names</span>(data), <span class="st">"nb_nul$|nb_vote_nul$"</span>)][<span class="dv">1</span>]</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>        <span class="at">nb_bl_nul =</span> <span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(blanc_col)) <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(nul_col))</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-!!</span><span class="fu">sym</span>(blanc_col), <span class="sc">-!!</span><span class="fu">sym</span>(nul_col)) <span class="sc">%&gt;%</span></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>      <span class="fu">relocate</span>(nb_bl_nul, <span class="at">.after =</span> nb_votant)</span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(exprim){</span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>     exprim_col <span class="ot">&lt;-</span> <span class="fu">names</span>(data)[<span class="fu">str_detect</span>(<span class="fu">names</span>(data), <span class="st">"nb_exprim$"</span>)][<span class="dv">1</span>]</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">nb_exprime =</span> <span class="sc">!!</span><span class="fu">sym</span>(exprim_col))</span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># On enlève les colonnes qu'on juge inutiles pour notre analyse en effet id_bvote contient toutes les informations sur l'emplacement du bureau de vote</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>  cols_to_remove <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"date"</span>,<span class="st">"created_user"</span>, <span class="st">"last_edited_user"</span>,</span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"last_edited_date"</span>,  <span class="st">"created_date"</span>, </span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"st_perimeter_shape"</span>,<span class="st">"st_area_shape"</span>,<span class="st">"nb_emarg"</span>,</span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"scrutin"</span>,<span class="st">"circ_bv"</span>,<span class="st">"quartier_bv"</span>,<span class="st">"sec_bv"</span>,</span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"numero_tour"</span>,<span class="st">"type_election"</span>,<span class="st">"date_tour"</span>,<span class="st">"arr_bv"</span>,</span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"tour"</span>,<span class="st">"annee"</span>,<span class="st">"num_circ"</span>,<span class="st">"num_quartier"</span>,<span class="st">"num_arrond"</span>,</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"num_bureau"</span>,<span class="st">"geo_shape"</span>,<span class="st">"geo_point_2d"</span>)</span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">any_of</span>(cols_to_remove))</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir tous les NA en 0  </span></span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">replace_na</span>(.x, <span class="dv">0</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">replace_na</span>(.x, <span class="st">"0"</span>))) </span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Chercher le fichier CSV de nuances correspondant</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>  csv_file_path <span class="ot">&lt;-</span> <span class="fu">find_csv_file</span>(name, <span class="st">"Data/Nuance"</span>)</span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(csv_file_path)) {</span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">mapping</span>(data, csv_file_path, name)</span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>  all_elections[[name]] <span class="ot">&lt;-</span> data</span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sauvegarder le résultat final</span></span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"DataClean"</span>, <span class="fu">paste0</span>(name, <span class="st">".parquet"</span>))</span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_parquet</span>(data, file_path)</span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_elections[[<span class="st">"presidentielles_2022_1t"</span>]])</span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>  <span class="co">#On trie par nuance politique</span></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>familles_nuance <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EXTREME_GAUCHE"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"EXG"</span>),          </span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GAUCHE"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"COM"</span>, <span class="st">"SOC"</span>,<span class="st">"LFI"</span>),                  </span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ECOLOGISTES"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ECO"</span>),                 </span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CENTRE"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ENS"</span>),                        </span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DROITE"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"LR"</span>,<span class="st">"DVD"</span>),                       </span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EXTREME_DROITE"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"RN"</span>, <span class="st">"REC"</span>),         </span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DIVERS"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"DSV"</span>, <span class="st">"REG"</span>)                </span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a><span class="co">#Calcule des scores pour l'ensemble des parties</span></span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="cf">function</span>(data, familles){</span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>  scores_familles <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>      <span class="at">EXTREME_GAUCHE =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>EXTREME_GAUCHE)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>      <span class="at">GAUCHE =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>GAUCHE)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>      <span class="at">ECOLOGISTES =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>ECOLOGISTES)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>      <span class="at">CENTRE =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>CENTRE)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>      <span class="at">DROITE =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>DROITE)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>      <span class="at">EXTREME_DROITE =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>EXTREME_DROITE)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">DIVERS =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(., <span class="fu">any_of</span>(familles<span class="sc">$</span>DIVERS)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">%&gt;%</span></span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>     <span class="fu">select</span>(id_bvote,nb_exprime, <span class="fu">all_of</span>(<span class="fu">names</span>(familles)))</span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(scores_familles)</span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a>donnees <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"DataClean/presidentielles_2022_1t.parquet"</span>)</span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a>scores_familles_2022 <span class="ot">&lt;-</span> <span class="fu">score</span>(donnees,</span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a>                              familles_nuance)</span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>analyser_pca <span class="ot">&lt;-</span> <span class="cf">function</span>(data_dir, nom_analyse) {</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>  donnees <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(data_dir)</span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>  score_familles <span class="ot">&lt;-</span> <span class="fu">score</span>(donnees,</span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>                             familles_nuance)</span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>  variables <span class="ot">&lt;-</span> <span class="fu">names</span>(familles_nuance)</span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>  variables_valides <span class="ot">&lt;-</span> variables[<span class="fu">sapply</span>(score_familles[variables],</span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a>                                        <span class="cf">function</span>(x) <span class="fu">var</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul de la PCA</span></span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>  pca_resultat <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(score_familles[, variables_valides], <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul de la variance expliquée</span></span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>  variance_expliquee <span class="ot">&lt;-</span> <span class="fu">summary</span>(pca_resultat)<span class="sc">$</span>importance[<span class="dv">2</span>,] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>  pc1_pct <span class="ot">&lt;-</span> <span class="fu">round</span>(variance_expliquee[<span class="dv">1</span>], <span class="dv">1</span>)</span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>  pc2_pct <span class="ot">&lt;-</span> <span class="fu">round</span>(variance_expliquee[<span class="dv">2</span>], <span class="dv">1</span>)</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>  pc1_pc2_total <span class="ot">&lt;-</span> <span class="fu">round</span>(pc1_pct <span class="sc">+</span> pc2_pct, <span class="dv">1</span>)</span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Graphique des valeurs propres</span></span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">fviz_eig</span>(pca_resultat, </span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>                 <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Valeurs propres -"</span>, nom_analyse, </span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"</span><span class="sc">\n</span><span class="st">PC1 + PC2 ="</span>, pc1_pc2_total, <span class="st">"%"</span>))</span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Graphique des variables</span></span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">fviz_pca_var</span>(pca_resultat,</span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col.var =</span> <span class="st">"contrib"</span>, </span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>                     <span class="at">gradient.cols =</span> <span class="fu">c</span>(<span class="st">"#00AFBB"</span>, <span class="st">"#E7B800"</span>, <span class="st">"#FC4E07"</span>),</span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>                     <span class="at">repel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>                     <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Variables -"</span>, nom_analyse))</span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Permet de savoir qui a été elu par burreau de vote</span></span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>  nuance_dominante <span class="ot">&lt;-</span> variables_valides[<span class="fu">apply</span>(score_familles[,</span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>                                                      variables], <span class="dv">1</span>, which.max)]</span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Graphique des individus</span></span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>  p3 <span class="ot">&lt;-</span> <span class="fu">fviz_pca_ind</span>(pca_resultat,</span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>                     <span class="at">geom.ind =</span> <span class="st">"point"</span>,</span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col.ind =</span> <span class="fu">as.factor</span>(nuance_dominante),</span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a>                     <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#1F78B4"</span>,<span class="st">"#E31A1C"</span>, <span class="st">"#33A02C"</span>, <span class="st">"#FF7F00"</span>, <span class="st">"#6A3D9A"</span>, <span class="st">"#B15928"</span>, <span class="st">"#FFFF33"</span>),</span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>                     <span class="at">addEllipses =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ellipse.level =</span> <span class="fl">0.95</span>,</span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>                     <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Bureaux de vote -"</span>, nom_analyse),</span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a>                     <span class="at">legend.title =</span> <span class="st">"Nuance dominante"</span>)</span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">eig =</span> p1, <span class="at">var =</span> p2, <span class="at">ind =</span> p3))</span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a>resultat_pca_2022 <span class="ot">&lt;-</span> <span class="fu">analyser_pca</span>(</span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_dir =</span> <span class="st">"DataClean/presidentielles_2022_1t.parquet"</span>,</span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>  <span class="at">nom_analyse =</span> <span class="st">"Présidentielles 2022"</span></span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>resultat_pca_2022<span class="sc">$</span>eig</span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>resultat_pca_2022<span class="sc">$</span>var</span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a>resultat_pca_2022<span class="sc">$</span>ind</span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a>resultat_pca_2017 <span class="ot">&lt;-</span> <span class="fu">analyser_pca</span>(<span class="st">"DataClean/presidentielles_2017_1t.parquet"</span>,</span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Présidentielles 2017 "</span></span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>                                 )</span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a>resultat_pca_2017<span class="sc">$</span>eig</span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a>resultat_pca_2017<span class="sc">$</span>var</span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a>resultat_pca_2017<span class="sc">$</span>ind</span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>resultat_pca_2012 <span class="ot">&lt;-</span> <span class="fu">analyser_pca</span>(<span class="st">"DataClean/presidentielles_2012_1t.parquet"</span>,</span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Présidentielles 2012"</span></span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>                                 )</span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a>resultat_pca_2012<span class="sc">$</span>eig</span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>resultat_pca_2012<span class="sc">$</span>var</span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>resultat_pca_2012<span class="sc">$</span>ind</span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>data_2022 <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"DataClean/presidentielles_2022_1t.parquet"</span>)</span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a>score_familles_2022 <span class="ot">&lt;-</span> <span class="fu">score</span>(data_2022,</span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a>                             familles_nuance)</span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>cor_familles_2022 <span class="ot">&lt;-</span> <span class="fu">cor</span>(score_familles_2022[, <span class="fu">names</span>(familles_nuance)])</span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>    corrplot_famille <span class="ot">&lt;-</span> <span class="fu">corrplot</span>(cor_familles_2022, <span class="at">method =</span> <span class="st">"color"</span>,</span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">type =</span> <span class="st">"upper"</span>,</span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">addCoef.col =</span> <span class="st">"black"</span>, <span class="at">tl.col =</span> <span class="st">"black"</span>,</span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">tl.srt =</span> <span class="dv">45</span>,</span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>             <span class="at">title =</span> <span class="st">"Corrélations familles politiques 2022"</span>, <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Fonction pour analyser la stabilité électorale entre deux élections</span></span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>analyser_stabilite_electorale <span class="ot">&lt;-</span> <span class="cf">function</span>(data_A_path, data_B_path, anneeA, anneeB,</span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>                                          familles ) {</span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>  donnees_A <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(data_A_path)</span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>  donnees_B <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(data_B_path)</span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>  scores_A <span class="ot">&lt;-</span> <span class="fu">score</span>(donnees_A, familles)</span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>  scores_B <span class="ot">&lt;-</span> <span class="fu">score</span>(donnees_B, familles)</span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul des pourcentages</span></span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>  variables_familles <span class="ot">&lt;-</span> <span class="fu">names</span>(familles)</span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Mettre le score en pourcentage pour rendre cela a la même echelle</span></span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a>  scores_A_pct <span class="ot">&lt;-</span> scores_A <span class="sc">%&gt;%</span></span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(variables_familles), </span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">~</span> <span class="fu">round</span>(.x <span class="sc">/</span> nb_exprime <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id_bvote, <span class="fu">paste0</span>(variables_familles))</span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>  scores_B_pct <span class="ot">&lt;-</span> scores_B <span class="sc">%&gt;%</span></span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(variables_familles), </span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">~</span> <span class="fu">round</span>(.x <span class="sc">/</span> nb_exprime <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id_bvote, <span class="fu">paste0</span>(variables_familles))</span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>  donnees_jointes <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(scores_A_pct, scores_B_pct, </span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>                                <span class="at">by =</span> <span class="st">"id_bvote"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_x"</span>,<span class="st">"_y"</span>))</span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a>  variables_x <span class="ot">&lt;-</span> <span class="fu">paste0</span>(variables_familles, <span class="st">"_x"</span>)</span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a>  variables_y <span class="ot">&lt;-</span> <span class="fu">paste0</span>(variables_familles, <span class="st">"_y"</span>)</span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filtrer les variables avec de la variance</span></span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a>  variables_x_valides <span class="ot">&lt;-</span> variables_x[<span class="fu">sapply</span>(donnees_jointes[variables_x], </span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">function</span>(x) <span class="fu">var</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a>  variables_y_valides <span class="ot">&lt;-</span> variables_y[<span class="fu">sapply</span>(donnees_jointes[variables_y], </span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a>                                            <span class="cf">function</span>(x) <span class="fu">var</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>)]</span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(donnees_jointes[, variables_x_valides])</span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(donnees_jointes[, variables_y_valides])</span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Analyse Canonique</span></span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>  cca_resultat <span class="ot">&lt;-</span> <span class="fu">cc</span>(X, Y)</span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>  correlations <span class="ot">&lt;-</span> <span class="fu">round</span>(cca_resultat<span class="sc">$</span>cor, <span class="dv">4</span>)</span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Interprétation de la stabilité</span></span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>  stabilite_globale <span class="ot">&lt;-</span> correlations[<span class="dv">1</span>]</span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calcul des scores canoniques</span></span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a>  scores_canoniques_x <span class="ot">&lt;-</span> X <span class="sc">%*%</span> cca_resultat<span class="sc">$</span>xcoef[, <span class="dv">1</span>]</span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>  scores_canoniques_y <span class="ot">&lt;-</span> Y <span class="sc">%*%</span> cca_resultat<span class="sc">$</span>ycoef[, <span class="dv">1</span>]</span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distance à la diagonale </span></span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>  distance_diagonale <span class="ot">&lt;-</span> <span class="fu">abs</span>(scores_canoniques_x <span class="sc">-</span> scores_canoniques_y)</span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>  donnees_jointes<span class="sc">$</span>distance_diagonale <span class="ot">&lt;-</span> distance_diagonale</span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a>  donnees_jointes<span class="sc">$</span>score_x <span class="ot">&lt;-</span> scores_canoniques_x</span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a>  donnees_jointes<span class="sc">$</span>score_y <span class="ot">&lt;-</span> scores_canoniques_y</span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-436"><a href="#cb3-436" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identification des bureaux les plus/moins stables</span></span>
<span id="cb3-437"><a href="#cb3-437" aria-hidden="true" tabindex="-1"></a>  seuil_stabilite <span class="ot">&lt;-</span> <span class="fu">quantile</span>(distance_diagonale, <span class="fl">0.9</span>)</span>
<span id="cb3-438"><a href="#cb3-438" aria-hidden="true" tabindex="-1"></a>  bureaux_instables <span class="ot">&lt;-</span> donnees_jointes[distance_diagonale <span class="sc">&gt;</span> seuil_stabilite, ]</span>
<span id="cb3-439"><a href="#cb3-439" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-440"><a href="#cb3-440" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Graphique diagonale de stabilité</span></span>
<span id="cb3-441"><a href="#cb3-441" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(donnees_jointes, <span class="fu">aes</span>(<span class="at">x =</span> score_x, <span class="at">y =</span> score_y)) <span class="sc">+</span></span>
<span id="cb3-442"><a href="#cb3-442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> distance_diagonale), <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb3-443"><a href="#cb3-443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-444"><a href="#cb3-444" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Stabilité électorale par bureau de vote "</span>,</span>
<span id="cb3-445"><a href="#cb3-445" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Corrélation canonique: "</span>, <span class="fu">round</span>(stabilite_globale, <span class="dv">3</span>)),</span>
<span id="cb3-446"><a href="#cb3-446" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"Score canonique "</span>, anneeA, <span class="st">" (1er tour)"</span>),</span>
<span id="cb3-447"><a href="#cb3-447" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"Score canonique "</span>, anneeB, <span class="st">" (1er tour)"</span>)) <span class="sc">+</span></span>
<span id="cb3-448"><a href="#cb3-448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb3-449"><a href="#cb3-449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb3-450"><a href="#cb3-450" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb3-451"><a href="#cb3-451" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-452"><a href="#cb3-452" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-453"><a href="#cb3-453" aria-hidden="true" tabindex="-1"></a>  tablo <span class="ot">&lt;-</span> bureaux_instables <span class="sc">%&gt;%</span> </span>
<span id="cb3-454"><a href="#cb3-454" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id_bvote, distance_diagonale, score_x, score_y) <span class="sc">%&gt;%</span></span>
<span id="cb3-455"><a href="#cb3-455" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(distance_diagonale)) <span class="sc">%&gt;%</span></span>
<span id="cb3-456"><a href="#cb3-456" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">10</span>)</span>
<span id="cb3-457"><a href="#cb3-457" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-458"><a href="#cb3-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-459"><a href="#cb3-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">stab =</span> p1, <span class="at">tableau =</span> tablo ))</span>
<span id="cb3-460"><a href="#cb3-460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-461"><a href="#cb3-461" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-462"><a href="#cb3-462" aria-hidden="true" tabindex="-1"></a>   cca_22_17 <span class="ot">&lt;-</span> <span class="fu">analyser_stabilite_electorale</span>(</span>
<span id="cb3-463"><a href="#cb3-463" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DataClean/presidentielles_2022_1t.parquet"</span>,</span>
<span id="cb3-464"><a href="#cb3-464" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DataClean/presidentielles_2017_1t.parquet"</span>,</span>
<span id="cb3-465"><a href="#cb3-465" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2022"</span>,</span>
<span id="cb3-466"><a href="#cb3-466" aria-hidden="true" tabindex="-1"></a>    <span class="st">"2017"</span>,</span>
<span id="cb3-467"><a href="#cb3-467" aria-hidden="true" tabindex="-1"></a>    familles_nuance</span>
<span id="cb3-468"><a href="#cb3-468" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-469"><a href="#cb3-469" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-470"><a href="#cb3-470" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-471"><a href="#cb3-471" aria-hidden="true" tabindex="-1"></a>  cca_22_17<span class="sc">$</span>stab</span>
<span id="cb3-472"><a href="#cb3-472" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-473"><a href="#cb3-473" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(cca_22_17<span class="sc">$</span>tableau,</span>
<span id="cb3-474"><a href="#cb3-474" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Bureau de vote"</span>, <span class="st">"Distance diagonale"</span>, </span>
<span id="cb3-475"><a href="#cb3-475" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(<span class="st">"Score "</span>, cca_22_17<span class="sc">$</span>anneeA), </span>
<span id="cb3-476"><a href="#cb3-476" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(<span class="st">"Score "</span>, cca_22_17 <span class="sc">$</span>anneeB)),</span>
<span id="cb3-477"><a href="#cb3-477" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb3-478"><a href="#cb3-478" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Top 10 des bureaux ayant le plus changé"</span>)</span>
<span id="cb3-479"><a href="#cb3-479" aria-hidden="true" tabindex="-1"></a>   cca_17_12 <span class="ot">&lt;-</span> <span class="fu">analyser_stabilite_electorale</span>(</span>
<span id="cb3-480"><a href="#cb3-480" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"DataClean/presidentielles_2017_1t.parquet"</span>,</span>
<span id="cb3-481"><a href="#cb3-481" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"DataClean/presidentielles_2012_1t.parquet"</span>,</span>
<span id="cb3-482"><a href="#cb3-482" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"2017"</span>,</span>
<span id="cb3-483"><a href="#cb3-483" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"2012"</span>,</span>
<span id="cb3-484"><a href="#cb3-484" aria-hidden="true" tabindex="-1"></a>                       familles_nuance</span>
<span id="cb3-485"><a href="#cb3-485" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-486"><a href="#cb3-486" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-487"><a href="#cb3-487" aria-hidden="true" tabindex="-1"></a> cca_17_12<span class="sc">$</span>stab</span>
<span id="cb3-488"><a href="#cb3-488" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(cca_17_12<span class="sc">$</span>tableau,</span>
<span id="cb3-489"><a href="#cb3-489" aria-hidden="true" tabindex="-1"></a>      <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Bureau de vote"</span>, <span class="st">"Distance diagonale"</span>, </span>
<span id="cb3-490"><a href="#cb3-490" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="st">"Score "</span>, cca_17_12<span class="sc">$</span>anneeA), </span>
<span id="cb3-491"><a href="#cb3-491" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="st">"Score "</span>, cca_17_12 <span class="sc">$</span>anneeB)),</span>
<span id="cb3-492"><a href="#cb3-492" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb3-493"><a href="#cb3-493" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Top 10 des bureaux ayant le plus changé"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>